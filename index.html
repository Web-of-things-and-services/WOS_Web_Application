<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta content="IE=edge" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Puissance4 Ft Minecraft Ft Pi</title>
    <!-- Compiled and minified CSS -->
    <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
    />
    <link
            href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
            rel="stylesheet"
    />

    <!-- Compiled and minified JavaScript -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <link href="css/index.css" rel="stylesheet"/>
</head>
<body>

<nav class="navbar">
    <div>Puissance 4 : PiBoy vs Minecraft player</div>
</nav>
<div class="myContainer">
    <div class="row mainRow">
        <div class="s4 col leftColumn">
            <div class="row center controlPanel">
                <a class="waves-effect waves-light blue darken-4 btn" onclick=startGame()
                ><i class="material-icons right">play_arrow</i>Commencer la
                    partie</a
                >
                <a class="waves-effect waves-light blue darken-4 btn" onclick=resetGame()
                ><i class="material-icons right">stop</i>Reset la partie</a
                >
                <div id="chat"></div>
                <h6>Joueurs connectés</h6>
                <ul class="collection" id="PlayersConnected">
                </ul>
            </div>
        </div>
        <div class="s8 col rightColumn">
            <div id="game">
            </div>
        </div>
    </div>
</div>
</body>
<script src="js/gameFront.js">
</script>
<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io("http://0.0.0.0:8888")
    let p4Front
    let playersConnected = []

    //initialisation de la partie
    socket.on("init_game", (payload) => {
        p4Front = new Puissance4Front("#game", payload.board);
        if (payload.displayWaitingMsg) {
            addToChat("En attente de connexion des joueurs");
        }
    });

    //reset de la partie 
    socket.on("init_game_after_reset", (payload) => {
        p4Front = new Puissance4Front("#game", payload.board);
        addToChat("Les deux joueurs sont toujours connectés !")
        addToChat(`C'est à ${payload.nextPlayer} de jouer !`)
    });

    //connexion d'un joueur
    socket.on("connect_player", (name) => {
        addToChat(`${name} est connecté`);
        playersConnected.push(name)
        updatePlayersConnectedHtml()
    });

    //Déconnexion d'un joueur

    socket.on("disconnected_player", (playerDisconnected) => {
        addToChat(`${playerDisconnected} vient de se déconnecter !`);
        playersConnected = playersConnected.filter(player => player !== playerDisconnected)
        console.log(playersConnected)
        updatePlayersConnectedHtml()
    });

    //tentative de connexion d'un joueur sans avoir démarrer une partie
    socket.on("connect_player_without_start", (name) => {
        addToChat(`${name} a voulu se connecter mais la partie n'a toujours pas commencée !`);
    });

    //afficher le joueur qui doit jouer
    socket.on("display_turn_player", (name) => {
        msg = `C'est à ${name} de jouer !`;
        addToChat(msg);
    });

    //tentative de connexion d'un client alors qu'il y a déja deux joueurs
    socket.on("alien_client", (name) => {
        addToChat(`${name} a essayé de se connecter mais il y a deja deux joueurs dans la partie !`);
    });

    //si un joueur dont ce n'est pas le tour joue
    socket.on("bad_player", (name) => {
        msg = `Ce n'est pas à ${name} de jouer !`;
        addToChat(msg);
    });

    //s'il manque un joueur
    socket.on("missing_player", () => {
        msg = "Vous ne pouvez pas encore jouer, il manque un joueur !";
        addToChat(msg)
    });

    //si un des joueurs a gagné la partie
    socket.on("win", (name) => {
        msg = `${name} a remporté la partie !`
        alert(`${name} a remporté la partie !`)
        addToChat(msg)
    });

    //si personne ne gagne à la fin 
    socket.on("nobody_win", () => {
        let msg = "Personne n'a remporté la partie !";
        addToChat(msg)
    });

    //nouveau coup d'un des joueurs
    socket.on("new_move", (move) => {
        p4Front.setBoard(move.board);
        p4Front.render();
        let msg = `${move.name} a posé un pion dans la colonne ${move.column}`;
        addToChat(msg);
    });

    /**
     * Permet d'ajouter un message dans le chat.
     * @param msg le message a afficher dans le chat
     */
    function addToChat(msg) {
        let paragraphElement = document.createElement("p")
        paragraphElement.innerHTML = msg;
        let chat = document.getElementById("chat")
        chat.appendChild(paragraphElement)
    }

    /**
     * Permet de commencer la partie, en envoyant l'événement "start_game" au serveur.
     */
    function startGame() {
        socket.emit("start_game")
    }

    /**
     * Permet de reset la partie, en envoyant l'événement "reset_game" au serveur.
     */
    function resetGame() {
        let chat = document.getElementById("chat")
        chat.innerHTML = ''
        addToChat(`La partie a été réinitialisé !`);
        socket.emit("reset_game")
    }

    function updatePlayersConnectedHtml() {
        let collection = document.getElementById("PlayersConnected")
        collection.innerHTML = ''
        for (const player of playersConnected) {
            let playerElement = document.createElement("li")
            playerElement.classList.add("collection-item")
            playerElement.innerText = player

            collection.appendChild(playerElement)
        }
    }
</script>
</html>
